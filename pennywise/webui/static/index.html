<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PennyWise</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a0f;
            --surface: rgba(255, 255, 255, 0.02);
            --surface-hover: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --text: #f0f0f0;
            --text-secondary: #888;
            --text-muted: #555;
            --accent: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --critical: #ff3b5c;
            --high: #ff8c42;
            --medium: #ffd93d;
            --low: #6bcb77;
            --info: #4d96ff;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        .bg-effects { position: fixed; inset: 0; pointer-events: none; z-index: -1; }
        .bg-gradient { position: absolute; width: 800px; height: 800px; border-radius: 50%; filter: blur(150px); opacity: 0.07; }
        .bg-gradient-1 { background: var(--accent); top: -400px; left: -200px; animation: drift 25s ease-in-out infinite; }
        .bg-gradient-2 { background: var(--accent-secondary); bottom: -400px; right: -200px; animation: drift 25s ease-in-out infinite reverse; }
        @keyframes drift { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(50px, 80px) scale(1.1); } }
        .noise { position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"); opacity: 0.03; }
        .app { max-width: 1100px; margin: 0 auto; padding: 1.5rem; min-height: 100vh; display: flex; flex-direction: column; gap: 1.25rem; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; }
        .brand { display: flex; align-items: center; gap: 0.875rem; }
        .brand-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 12px; display: grid; place-items: center; font-size: 1.25rem; box-shadow: 0 0 30px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.2); }
        .brand-name { font-size: 1.375rem; font-weight: 700; letter-spacing: -0.02em; }
        .brand-name span { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status-pill { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 100px; font-size: 0.75rem; color: var(--text-secondary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--low); box-shadow: 0 0 8px var(--low); transition: all 0.3s; }
        .status-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transition: all 0.3s ease; }
        .card:hover { border-color: var(--border-hover); }
        .control-card { padding: 1.5rem; }
        .input-section { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; }
        .url-input-wrapper { flex: 1; position: relative; }
        .url-input { width: 100%; padding: 1rem 1rem 1rem 2.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; transition: all 0.2s; }
        .url-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .url-input::placeholder { color: var(--text-muted); }
        .url-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.875rem; }
        .btn { padding: 1rem 1.75rem; border: none; border-radius: 12px; font-family: inherit; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.02em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #00a8cc); color: #000; box-shadow: 0 4px 15px var(--accent-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--accent-glow); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .options-grid { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .option-tag { padding: 0.6rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: 10px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
        .option-tag:hover { border-color: var(--border-hover); background: var(--surface); }
        .option-tag.active { background: rgba(0, 212, 255, 0.1); border-color: var(--accent); color: var(--accent); }
        .divider { width: 1px; height: 24px; background: var(--border); margin: 0 0.5rem; }
        .quick-actions { display: flex; gap: 0.5rem; margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid var(--border); }
        .quick-btn { padding: 0.65rem 1rem; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border); border-radius: 10px; color: var(--text-secondary); font-family: inherit; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
        .quick-btn:hover { background: var(--surface); border-color: var(--border-hover); color: var(--text); }
        .quick-btn.highlight { background: rgba(0, 212, 255, 0.08); border-color: rgba(0, 212, 255, 0.3); color: var(--accent); }
        .stats-row { display: flex; gap: 1rem; padding: 1rem 1.5rem; }
        .stat-item { display: flex; align-items: baseline; gap: 0.4rem; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.125rem; font-weight: 600; color: var(--accent); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .severity-pills { display: flex; gap: 0.75rem; margin-left: auto; }
        .sev-pill { display: flex; align-items: center; gap: 0.35rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
        .sev-indicator { width: 10px; height: 10px; border-radius: 3px; }
        .sev-indicator.critical { background: var(--critical); box-shadow: 0 0 6px var(--critical); }
        .sev-indicator.high { background: var(--high); }
        .sev-indicator.medium { background: var(--medium); }
        .sev-indicator.low { background: var(--low); }
        .progress-container { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; margin: 0 1.5rem; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-secondary)); border-radius: 2px; transition: width 0.3s ease; }
        .progress-bar.scanning { width: 30% !important; animation: scanning 1.2s ease-in-out infinite; }
        @keyframes scanning { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
        .log-card { flex: 1; display: flex; flex-direction: column; min-height: 400px; overflow: hidden; }
        .log-header { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); }
        .log-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); }
        .log-badge { padding: 0.25rem 0.6rem; background: rgba(0, 212, 255, 0.1); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent); }
        .phase-indicator { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; font-size: 0.7rem; color: var(--text-muted); }
        .phase-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: blink 0.8s ease-in-out infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .log-feed { flex: 1; padding: 0.75rem; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; background: rgba(0,0,0,0.4); font-family: 'JetBrains Mono', monospace; }
        .log-feed::-webkit-scrollbar { width: 5px; }
        .log-feed::-webkit-scrollbar-track { background: transparent; }
        .log-feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .log-entry { padding: 0.35rem 0.5rem; background: transparent; border-radius: 0; border-left: none; animation: fadeSlide 0.2s ease-out; font-size: 0.75rem; display: flex; align-items: flex-start; gap: 0.5rem; }
        @keyframes fadeSlide { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry:hover { background: rgba(255,255,255,0.03); }
        .log-entry.critical { color: var(--critical); }
        .log-entry.high { color: var(--high); }
        .log-entry.medium { color: var(--medium); }
        .log-entry.low { color: var(--low); }
        .log-entry.info { color: var(--info); }
        .log-entry.system { color: var(--accent); }
        .log-entry.url { color: #888; }
        .log-entry.success { color: var(--low); }
        .log-prefix { color: #666; font-weight: normal; min-width: 80px; }
        .log-prefix i { margin-right: 4px; font-size: 0.7rem; }
        .log-time { font-size: 0.7rem; color: #555; min-width: 65px; }
        .log-tag { padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.02em; }
        .log-tag.critical { background: var(--critical); color: #fff; }
        .log-tag.high { background: var(--high); color: #000; }
        .log-tag.medium { background: var(--medium); color: #000; }
        .log-tag.low { background: var(--low); color: #000; }
        .log-tag.xss { background: #7c3aed; color: #fff; }
        .log-tag.sqli { background: #ec4899; color: #fff; }
        .log-tag.csrf { background: #f97316; color: #000; }
        .log-content { color: inherit; line-height: 1.3; flex: 1; }
        .log-url { font-size: 0.65rem; color: #666; word-break: break-all; margin-left: 145px; }
        .log-evidence { margin-top: 0.25rem; margin-left: 145px; padding: 0.4rem 0.5rem; background: rgba(0, 0, 0, 0.4); border-radius: 4px; font-size: 0.65rem; color: var(--accent); overflow-x: auto; white-space: pre-wrap; word-break: break-all; border: 1px solid rgba(0,212,255,0.1); }
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; color: var(--text-muted); text-align: center; padding: 3rem; }
        .empty-icon { width: 80px; height: 80px; border-radius: 20px; background: var(--surface); border: 1px solid var(--border); display: grid; place-items: center; font-size: 2rem; opacity: 0.5; }
        .empty-text { font-size: 0.875rem; max-width: 280px; line-height: 1.5; }
        .summary-card { background: linear-gradient(135deg, rgba(0,212,255,0.03), rgba(124,58,237,0.03)); border: 1px solid rgba(0,212,255,0.2); border-radius: 12px; padding: 1.25rem; margin-top: 0.5rem; }
        .summary-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
        .summary-title { font-size: 0.9rem; font-weight: 600; color: var(--accent); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .summary-section { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; }
        .summary-section-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
        .summary-stat { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid var(--border); }
        .summary-stat:last-child { border-bottom: none; }
        .summary-stat-label { font-size: 0.8rem; color: var(--text-secondary); }
        .summary-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; }
        .summary-stat-value.critical { color: var(--critical); }
        .summary-stat-value.high { color: var(--high); }
        .summary-stat-value.medium { color: var(--medium); }
        .summary-stat-value.low { color: var(--low); }
        .findings-list { max-height: 300px; overflow-y: auto; }
        .finding-item { padding: 0.75rem; background: rgba(0,0,0,0.15); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--border); }
        .finding-item.critical { border-left-color: var(--critical); }
        .finding-item.high { border-left-color: var(--high); }
        .finding-item.medium { border-left-color: var(--medium); }
        .finding-item.low { border-left-color: var(--low); }
        .finding-title { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.3rem; }
        .finding-meta { display: flex; gap: 0.5rem; font-size: 0.65rem; color: var(--text-muted); }
        .finding-url { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.3rem; word-break: break-all; }
        @media (max-width: 768px) { .app { padding: 1rem; } .input-section { flex-direction: column; } .stats-row { flex-wrap: wrap; } .severity-pills { margin-left: 0; margin-top: 0.5rem; width: 100%; } }
    </style>
</head>
<body>
    <div class="bg-effects"><div class="bg-gradient bg-gradient-1"></div><div class="bg-gradient bg-gradient-2"></div><div class="noise"></div></div>
    <div class="app">
        <header class="header">
            <div class="brand"><div class="brand-icon"><i class="fas fa-shield-halved"></i></div><div class="brand-name"><span>Penny</span>Wise</div></div>
            <div class="status-pill"><div class="status-dot" id="statusDot"></div><span id="statusText">Ready</span></div>
        </header>
        <div class="card control-card">
            <div class="input-section">
                <div class="url-input-wrapper"><span class="url-icon"><i class="fas fa-globe"></i></span><input type="text" class="url-input" id="targetUrl" placeholder="https://target.com" value="http://localhost:8888"></div>
                <button class="btn btn-primary" id="scanBtn" onclick="startScan()"><i id="scanIcon" class="fas fa-bolt"></i><span id="scanText">Scan</span></button>
            </div>
            <div class="options-grid">
                <button class="option-tag active" data-type="xss" onclick="toggleOption(this)"><i class="fas fa-code"></i> XSS</button>
                <button class="option-tag active" data-type="sqli" onclick="toggleOption(this)"><i class="fas fa-database"></i> SQLi</button>
                <button class="option-tag active" data-type="csrf" onclick="toggleOption(this)"><i class="fas fa-unlock"></i> CSRF</button>
                <button class="option-tag" data-type="lfi" onclick="toggleOption(this)"><i class="fas fa-folder-open"></i> LFI</button>
                <button class="option-tag" data-type="rce" onclick="toggleOption(this)"><i class="fas fa-terminal"></i> RCE</button>
                <div class="divider"></div>
                <button class="option-tag active" id="crawlToggle" onclick="this.classList.toggle('active')"><i class="fas fa-spider"></i> Crawl</button>
            </div>
            <div class="quick-actions">
                <button class="quick-btn highlight" onclick="testLocal()"><i class="fas fa-flask"></i> Test Local</button>
                <button class="quick-btn" onclick="clearLogs()"><i class="fas fa-trash-can"></i> Clear</button>
                <button class="quick-btn" onclick="exportResults()"><i class="fas fa-file-export"></i> Export</button>
            </div>
        </div>
        <div class="card stats-row">
            <div class="stat-item"><span class="stat-value" id="statPages">0</span><span class="stat-label">pages</span></div>
            <div class="stat-item"><span class="stat-value" id="statRequests">0</span><span class="stat-label">requests</span></div>
            <div class="stat-item"><span class="stat-value" id="statFindings">0</span><span class="stat-label">findings</span></div>
            <div class="stat-item"><span class="stat-value" id="statTime">0s</span><span class="stat-label">time</span></div>
            <div class="severity-pills">
                <div class="sev-pill"><div class="sev-indicator critical"></div><span id="sevCritical">0</span></div>
                <div class="sev-pill"><div class="sev-indicator high"></div><span id="sevHigh">0</span></div>
                <div class="sev-pill"><div class="sev-indicator medium"></div><span id="sevMedium">0</span></div>
                <div class="sev-pill"><div class="sev-indicator low"></div><span id="sevLow">0</span></div>
            </div>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="card log-card">
            <div class="log-header">
                <span class="log-title"><i class="fas fa-stream"></i> Live Feed</span>
                <span class="log-badge" id="logCount">0</span>
                <div class="phase-indicator" id="phaseIndicator" style="display:none"><div class="phase-dot"></div><span id="phaseText">Initializing...</span></div>
            </div>
            <div class="log-feed" id="logFeed">
                <div class="empty-state" id="emptyState"><div class="empty-icon"><i class="fas fa-shield-halved"></i></div><div class="empty-text">Enter a target URL and start scanning to see vulnerabilities appear here</div></div>
            </div>
        </div>
    </div>
    <script>
        let isScanning=false,findings=[],startTime=null,timerInterval=null,sevCounts={critical:0,high:0,medium:0,low:0},currentPhase='';
        const logFeed=document.getElementById('logFeed'),emptyState=document.getElementById('emptyState'),scanBtn=document.getElementById('scanBtn'),statusDot=document.getElementById('statusDot'),statusText=document.getElementById('statusText'),progressBar=document.getElementById('progressBar'),phaseIndicator=document.getElementById('phaseIndicator'),phaseText=document.getElementById('phaseText');
        
        function toggleOption(el){el.classList.toggle('active')}
        function getSelectedTypes(){return Array.from(document.querySelectorAll('.option-tag.active[data-type]')).map(el=>el.dataset.type)}
        function setPhase(phase){currentPhase=phase;phaseText.textContent=phase;phaseIndicator.style.display=phase?'flex':'none'}
        
        function log(type,title,url='',evidence='',severity='',attackType=''){
            emptyState.style.display='none';
            const entry=document.createElement('div');
            entry.className=`log-entry ${type}`;
            const time=new Date().toLocaleTimeString('en-US',{hour12:false});
            
            // Terminal-style icons and prefixes
            const iconMap = {
                'system': '<i class="fas fa-terminal"></i>',
                'info': '<i class="fas fa-circle-info"></i>',
                'critical': '<i class="fas fa-skull-crossbones"></i>',
                'high': '<i class="fas fa-radiation"></i>',
                'medium': '<i class="fas fa-triangle-exclamation"></i>',
                'low': '<i class="fas fa-circle-exclamation"></i>',
                'url': '<i class="fas fa-link"></i>',
                'success': '<i class="fas fa-circle-check"></i>'
            };
            const prefixMap = {
                'system': '[SYS]',
                'info': '[INF]',
                'critical': '[CRT]',
                'high': '[HIG]',
                'medium': '[MED]',
                'low': '[LOW]',
                'url': '[URL]',
                'success': '[OK]'
            };
            const icon = iconMap[type] || '<i class="fas fa-circle"></i>';
            const prefix = prefixMap[type] || '[LOG]';
            
            let tags='';
            if(severity)tags+=`<span class="log-tag ${severity.toLowerCase()}">${severity}</span> `;
            if(attackType)tags+=`<span class="log-tag ${attackType.toLowerCase()}">${attackType}</span> `;
            
            const mainLine = document.createElement('div');
            mainLine.style.cssText = 'display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;';
            mainLine.innerHTML=`<span class="log-time">${time}</span><span class="log-prefix">${icon} ${prefix}</span>${tags}<span class="log-content">${escapeHtml(title)}</span>`;
            entry.appendChild(mainLine);
            
            if(url){
                const urlLine = document.createElement('div');
                urlLine.className = 'log-url';
                urlLine.innerHTML = '<i class="fas fa-arrow-right"></i> ' + escapeHtml(url);
                entry.appendChild(urlLine);
            }
            if(evidence){
                const evLine = document.createElement('div');
                evLine.className = 'log-evidence';
                evLine.textContent = evidence.substring(0,300) + (evidence.length>300?'...':'');
                entry.appendChild(evLine);
            }
            
            logFeed.appendChild(entry);
            logFeed.scrollTop=logFeed.scrollHeight;
            updateLogCount();
        }
        
        function updateLogCount(){document.getElementById('logCount').textContent=logFeed.querySelectorAll('.log-entry').length}
        function updateStats(pages,requests,findingsCount,duration){document.getElementById('statPages').textContent=pages;document.getElementById('statRequests').textContent=requests;document.getElementById('statFindings').textContent=findingsCount;document.getElementById('statTime').textContent=`${Math.round(duration)}s`}
        function updateSeverityCounts(){document.getElementById('sevCritical').textContent=sevCounts.critical;document.getElementById('sevHigh').textContent=sevCounts.high;document.getElementById('sevMedium').textContent=sevCounts.medium;document.getElementById('sevLow').textContent=sevCounts.low}
        function startTimer(){startTime=Date.now();timerInterval=setInterval(()=>{document.getElementById('statTime').textContent=`${Math.round((Date.now()-startTime)/1000)}s`},1000)}
        function stopTimer(){if(timerInterval){clearInterval(timerInterval);timerInterval=null}}
        function setScanning(scanning){isScanning=scanning;statusDot.classList.toggle('active',scanning);statusText.textContent=scanning?'Scanning':'Ready';scanBtn.disabled=scanning;document.getElementById('scanIcon').className=scanning?'fas fa-spinner fa-spin':'fas fa-bolt';document.getElementById('scanText').textContent=scanning?'Scanning...':'Scan';progressBar.classList.toggle('scanning',scanning);if(scanning)startTimer();else{stopTimer();progressBar.style.width='100%';setPhase('');setTimeout(()=>progressBar.classList.remove('scanning'),300)}}
        
        async function startScan() {
            const url=document.getElementById('targetUrl').value.trim();
            if(!url){log('system','Please enter a target URL');return}
            const types=getSelectedTypes();
            if(types.length===0){log('system','Select at least one attack type');return}
            const crawl=document.getElementById('crawlToggle').classList.contains('active');
            resetStats();setScanning(true);
            log('system',`Target: ${url}`);
            log('info',`Attack vectors: ${types.map(t=>t.toUpperCase()).join(', ')}`);
            setPhase('Initializing...');
            
            try {
                // Use SSE streaming for real-time updates
                const params = new URLSearchParams({
                    url: url,
                    attack_types: types.join(','),
                    crawl: crawl
                });
                const eventSource = new EventSource(`/api/scan/stream?${params.toString()}`);
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if(data.type === 'progress') {
                        setPhase(data.phase || 'Scanning...');
                        if(data.percent) progressBar.style.width = data.percent + '%';
                        // Update pages and requests from progress
                        if(data.pages !== undefined) document.getElementById('statPages').textContent = data.pages;
                        if(data.requests !== undefined) document.getElementById('statRequests').textContent = data.requests;
                    } else if(data.type === 'finding') {
                        const f = data.finding;
                        const sev = (f.severity || 'info').toLowerCase();
                        if(sevCounts.hasOwnProperty(sev)) sevCounts[sev]++;
                        findings.push(f);
                        log(sev, `VULN: ${f.title || 'Vulnerability'}`, f.url, f.evidence, f.severity, f.attack_type);
                        document.getElementById('statFindings').textContent = findings.length;
                        updateSeverityCounts();
                    } else if(data.type === 'complete') {
                        const result = data.result || {};
                        const pages = result.pages_scanned || result.pages_crawled || 0;
                        const requests = result.requests_made || 0;
                        const duration = result.scan_duration || result.duration_seconds || 0;
                        updateStats(pages, requests, findings.length, duration);
                        eventSource.close();
                        setScanning(false);
                        showSummary();
                    } else if(data.type === 'error') {
                        log('system', `Error: ${data.error || 'Scan failed'}`);
                        eventSource.close();
                        setScanning(false);
                    } else if(data.type === 'log') {
                        // Show log messages - check for URLs being tested
                        const msg = data.message || '';
                        const level = data.level || 'info';
                        if(msg.includes('Testing') || msg.includes('http')) {
                            log('url', msg);
                        } else if(level === 'success' || msg.includes('FOUND') || msg.includes('VULN')) {
                            log('success', msg);
                        } else {
                            log('info', msg);
                        }
                    }
                };
                
                eventSource.onerror = function(err) {
                    log('system', 'Connection lost');
                    eventSource.close();
                    setScanning(false);
                };
            } catch (error) {
                log('system',`Error: ${error.message}`);
                setScanning(false);
            }
        }
        
        async function testLocal() {
            document.getElementById('targetUrl').value='http://localhost:8888/sandbox';
            resetStats();setScanning(true);
            log('system','Testing local vulnerable server...');
            log('info','Target: localhost:8888/sandbox (vulnerable sandbox)');
            setPhase('Initializing...');
            
            try {
                // Use SSE streaming for real-time updates
                const eventSource = new EventSource('/api/test-local/stream?port=8888&attack_types=xss,sqli,csrf');
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if(data.type === 'progress') {
                        setPhase(data.phase || 'Scanning...');
                        if(data.percent) progressBar.style.width = data.percent + '%';
                        // Update pages and requests from progress
                        if(data.pages !== undefined) document.getElementById('statPages').textContent = data.pages;
                        if(data.requests !== undefined) document.getElementById('statRequests').textContent = data.requests;
                    } else if(data.type === 'finding') {
                        const f = data.finding;
                        const sev = (f.severity || 'info').toLowerCase();
                        if(sevCounts.hasOwnProperty(sev)) sevCounts[sev]++;
                        findings.push(f);
                        log(sev, `VULN: ${f.title || 'Vulnerability'}`, f.url, f.evidence, f.severity, f.attack_type);
                        document.getElementById('statFindings').textContent = findings.length;
                        updateSeverityCounts();
                    } else if(data.type === 'complete') {
                        const result = data.result || {};
                        const pages = result.pages_scanned || result.pages_crawled || 0;
                        const requests = result.requests_made || 0;
                        const duration = result.scan_duration || result.duration_seconds || 0;
                        updateStats(pages, requests, findings.length, duration);
                        eventSource.close();
                        setScanning(false);
                        showSummary();
                    } else if(data.type === 'error') {
                        log('system', `Error: ${data.error || 'Test failed'}`);
                        log('info','Run: python -m pennywise.sandbox.vulnerable_server');
                        eventSource.close();
                        setScanning(false);
                    } else if(data.type === 'log') {
                        // Show log messages - check for URLs being tested
                        const msg = data.message || '';
                        const level = data.level || 'info';
                        if(msg.includes('Testing') || msg.includes('http')) {
                            log('url', msg);
                        } else if(level === 'success' || msg.includes('FOUND') || msg.includes('VULN')) {
                            log('success', msg);
                        } else {
                            log('info', msg);
                        }
                    }
                };
                
                eventSource.onerror = function(err) {
                    log('system', 'Connection lost');
                    eventSource.close();
                    setScanning(false);
                };
            } catch(error) {
                log('system',`Error: ${error.message}`);
                setScanning(false);
            }
        }
        
        function handleResults(result) {
            const allFindings = result.findings || [];
            findings = allFindings;
            setPhase('Processing results...');
            
            // Show findings one by one with slight delay for visual effect
            allFindings.forEach((f, i) => {
                setTimeout(() => {
                    const sev = (f.severity || 'info').toLowerCase();
                    if(sevCounts.hasOwnProperty(sev)) sevCounts[sev]++;
                    log(sev, `VULN: ${f.title || 'Vulnerability'}`, f.url, f.evidence, f.severity, f.attack_type);
                    document.getElementById('statFindings').textContent = i + 1;
                    updateSeverityCounts();
                }, i * 100); // 100ms delay between each finding
            });
            
            const duration = result.summary?.duration_seconds || result.duration_seconds || 0;
            const pages = result.summary?.pages_crawled || result.pages_crawled || 0;
            const requests = result.summary?.requests_made || result.requests_made || 0;
            
            setTimeout(() => {
                updateStats(pages, requests, allFindings.length, duration);
            }, allFindings.length * 100 + 100);
        }
        
        function showSummary() {
            setTimeout(() => {
                setPhase('');
                if(findings.length === 0) {
                    log('success', 'Scan complete - No vulnerabilities found!');
                    return;
                }
                
                // Create summary card
                const summary = document.createElement('div');
                summary.className = 'summary-card';
                
                const riskLevel = sevCounts.critical > 0 ? 'CRITICAL' : sevCounts.high > 0 ? 'HIGH' : sevCounts.medium > 0 ? 'MEDIUM' : 'LOW';
                const riskColor = sevCounts.critical > 0 ? 'var(--critical)' : sevCounts.high > 0 ? 'var(--high)' : sevCounts.medium > 0 ? 'var(--medium)' : 'var(--low)';
                
                // Group by attack type
                const byType = {};
                findings.forEach(f => {
                    const type = f.attack_type || 'unknown';
                    if(!byType[type]) byType[type] = [];
                    byType[type].push(f);
                });
                
                let findingsHtml = '';
                for(const [type, typefindings] of Object.entries(byType)) {
                    findingsHtml += `<div style="margin-bottom:1rem"><div style="font-size:0.75rem;color:var(--accent);font-weight:600;margin-bottom:0.5rem;text-transform:uppercase"><i class="fas fa-folder-open"></i> ${type} (${typefindings.length})</div>`;
                    typefindings.slice(0, 5).forEach(f => {
                        const sev = (f.severity || 'info').toLowerCase();
                        findingsHtml += `<div class="finding-item ${sev}">
                            <div class="finding-title"><i class="fas fa-bug"></i> ${escapeHtml(f.title || 'Vulnerability')}</div>
                            <div class="finding-meta"><span style="color:var(--${sev})">${f.severity||'INFO'}</span><span>${f.parameter?'Param: '+f.parameter:''}</span></div>
                            ${f.url?`<div class="finding-url"><i class="fas fa-link"></i> ${escapeHtml(f.url)}</div>`:''}
                        </div>`;
                    });
                    if(typefindings.length > 5) findingsHtml += `<div style="font-size:0.7rem;color:var(--text-muted);padding:0.5rem">... and ${typefindings.length - 5} more</div>`;
                    findingsHtml += '</div>';
                }
                
                summary.innerHTML = `
                    <div class="summary-header">
                        <i class="fas fa-clipboard-list" style="font-size:1.25rem;color:var(--accent)"></i>
                        <span class="summary-title">Scan Report</span>
                        <span style="margin-left:auto;padding:0.3rem 0.75rem;background:${riskColor};color:#000;border-radius:6px;font-size:0.7rem;font-weight:700">${riskLevel} RISK</span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-section">
                            <div class="summary-section-title"><i class="fas fa-chart-pie"></i> Severity Breakdown</div>
                            <div class="summary-stat"><span class="summary-stat-label">Critical</span><span class="summary-stat-value critical">${sevCounts.critical}</span></div>
                            <div class="summary-stat"><span class="summary-stat-label">High</span><span class="summary-stat-value high">${sevCounts.high}</span></div>
                            <div class="summary-stat"><span class="summary-stat-label">Medium</span><span class="summary-stat-value medium">${sevCounts.medium}</span></div>
                            <div class="summary-stat"><span class="summary-stat-label">Low</span><span class="summary-stat-value low">${sevCounts.low}</span></div>
                        </div>
                        <div class="summary-section">
                            <div class="summary-section-title"><i class="fas fa-crosshairs"></i> Attack Types</div>
                            ${Object.entries(byType).map(([t,f])=>`<div class="summary-stat"><span class="summary-stat-label">${t.toUpperCase()}</span><span class="summary-stat-value">${f.length}</span></div>`).join('')}
                        </div>
                    </div>
                    <div style="margin-top:1rem">
                        <div class="summary-section-title"><i class="fas fa-list"></i> Findings Detail</div>
                        <div class="findings-list">${findingsHtml}</div>
                    </div>
                `;
                
                logFeed.appendChild(summary);
                logFeed.scrollTop = logFeed.scrollHeight;
                log('success', `Scan complete - Found ${findings.length} vulnerabilities`);
            }, findings.length * 100 + 500);
        }
        
        function clearLogs(){logFeed.innerHTML='';logFeed.appendChild(emptyState);emptyState.style.display='flex';resetStats();updateLogCount()}
        function resetStats(){sevCounts={critical:0,high:0,medium:0,low:0};findings=[];updateStats(0,0,0,0);updateSeverityCounts();progressBar.style.width='0%'}
        function exportResults(){if(findings.length===0){log('system','Nothing to export');return}const data={timestamp:new Date().toISOString(),findings_count:findings.length,severity_breakdown:sevCounts,findings};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`pennywise-${Date.now()}.json`;a.click();URL.revokeObjectURL(url);log('success','Results exported')}
        function escapeHtml(text){if(!text)return'';const d=document.createElement('div');d.textContent=text;return d.innerHTML}
        document.getElementById('targetUrl').addEventListener('keypress',e=>{if(e.key==='Enter'&&!isScanning)startScan()});
    </script>
</body>
</html>